# Call Rate Anomaly Detection - 调用频率异变检测

## 📋 异味定义

**Call Rate Anomaly（调用频率异变）** 是指某个服务实例的API调用次数在短时间内与历史正常水平显著偏离的现象。当正常调用频率受到扰动时，这可能表明存在潜在问题，例如请求激增、服务被攻击或其他非典型场景。

## 🎯 检测思路

### 业务导向的简化检测方法

采用**业务导向**的检测策略，避免复杂的统计学假设，基于实际业务经验制定简单有效的判定规则。

### 核心算法

```java
检测步骤：
1. 获取当前时刻往前的4个时间间隔的请求量数据
2. 计算前3个时间间隔的请求量平均值作为历史基准
3. 比较最新时间间隔的请求量与历史平均值
4. 应用业务规则进行异常判定
```

## 🔍 检测规则

### 主要判定条件

| 条件 | 阈值 | 说明 |
|------|------|------|
| **激增倍数** | ≥ 1.8倍 | 当前请求量达到历史平均值的1.8倍以上 |
| **增长率** | ≥ 100% | 请求量翻倍增长直接判定为异常 |

### 激增程度分级

| 等级 | 倍数范围 | 描述 | 业务含义 |
|------|----------|------|----------|
| **NORMAL** | < 1.5x | 正常范围 | 正常的业务波动 |
| **MILD** | 1.5x - 1.8x | 轻度激增 | 需要关注但未达异常阈值 |
| **MODERATE** | 1.8x - 2.0x | 中度激增 | 达到异常阈值，需要调查 |
| **HIGH** | 2.0x - 3.0x | 高度激增 | 明显异常，需要立即处理 |
| **EXTREME** | ≥ 3.0x | 极端激增 | 严重异常，可能是攻击或故障 |

## 💡 算法实现

### 数据结构

```java
public class CallRateAnomalyItem {
    private Boolean status;                    // 是否检测到异常
    private Integer currentRequestCount;       // 当前请求量
    private Double historicalAvgRequestCount;  // 历史平均请求量
    private Double growthMultiplier;          // 增长倍数
    private Double growthPercentage;          // 增长百分比
    private String surgeLevel;                // 激增等级
    private String historicalTrend;           // 历史趋势
    private String detectionReason;           // 检测原因
    private Integer detectionInterval;        // 检测间隔
}
```

### 核心算法

```java
private BusinessOrientedDetectionResult performBusinessOrientedDetection(List<Integer> requestCounts) {
    // 1. 数据预处理
    int currentCount = requestCounts.get(requestCounts.size() - 1);
    List<Integer> historicalCounts = requestCounts.subList(0, requestCounts.size() - 1);
    
    // 2. 计算历史平均值
    double historicalAvg = historicalCounts.stream()
        .mapToInt(Integer::intValue)
        .average()
        .orElse(0.0);
    
    // 3. 计算增长指标
    double growthMultiplier = currentCount / historicalAvg;
    double growthPercentage = (currentCount - historicalAvg) / historicalAvg * 100;
    
    // 4. 应用业务规则
    boolean isAnomaly = growthMultiplier >= 1.8 || growthPercentage >= 100.0;
    
    // 5. 确定激增等级和原因
    return buildDetectionResult(currentCount, historicalAvg, growthMultiplier, growthPercentage, isAnomaly);
}
```

## ✅ 优点

### 1. **简单直观**
- **算法简单**：避免复杂的统计学计算，易于理解和实现
- **规则明确**：1.8倍和100%的阈值具有明确的业务含义
- **结果可解释**：检测结果易于向业务人员解释

### 2. **业务导向**
- **实用性强**：基于实际业务经验制定规则
- **阈值合理**：1.8倍激增在大多数业务场景下都是显著异常
- **分级清晰**：多级别的激增程度便于优先级处理

### 3. **计算高效**
- **性能优越**：只需简单的算术运算，计算开销极小
- **实时性好**：适合实时监控和告警场景
- **资源消耗低**：对系统资源要求很低

### 4. **鲁棒性强**
- **数据要求低**：最少只需2个数据点即可检测
- **抗噪声**：基于平均值，对单个异常值有一定抗性
- **边界处理**：对零值、缺失值等边界情况有完善处理

## ❌ 缺点

### 1. **统计学局限性**
- **缺乏理论基础**：没有严格的统计学理论支撑
- **假阳性风险**：可能将正常的业务高峰误判为异常
- **阈值固定**：1.8倍阈值可能不适用于所有业务场景

### 2. **时间特征忽略**
- **周期性盲点**：无法识别周期性的请求模式（如日周期）
- **趋势忽略**：不考虑长期增长趋势，可能误判正常增长
- **季节性**：无法处理季节性业务波动

### 3. **上下文缺失**
- **单一维度**：只考虑请求量，忽略其他相关指标
- **业务上下文**：不考虑特殊业务事件（如促销活动）
- **服务依赖**：不考虑上下游服务的影响

### 4. **精度限制**
- **粒度粗糙**：基于固定时间间隔，可能错过短时间内的异常
- **延迟检测**：需要等待完整时间间隔结束才能检测
- **历史长度**：只使用3个历史数据点，历史信息有限

## 🎯 适用场景

### ✅ 适合的场景

1. **实时监控系统**
   - 需要快速响应的告警场景
   - 对计算性能要求高的环境
   - 简单有效的异常检测需求

2. **稳定业务系统**
   - 请求模式相对稳定的服务
   - 没有明显周期性波动的业务
   - 突发流量需要快速识别的场景

3. **初级监控需求**
   - 刚开始实施监控的系统
   - 需要简单易懂的检测方法
   - 对检测精度要求不是极高的场景

### ❌ 不适合的场景

1. **复杂业务模式**
   - 有明显日周期、周周期的业务
   - 季节性业务波动明显
   - 业务模式经常变化的系统

2. **高精度要求**
   - 需要极低误报率的关键系统
   - 对检测精度有严格要求
   - 需要考虑多维度指标的场景

3. **动态环境**
   - 微服务频繁扩缩容
   - 业务逻辑经常调整
   - 流量模式不稳定的系统

## 🔧 优化建议

### 短期改进

1. **动态阈值**：根据历史数据动态调整1.8倍阈值
2. **时间窗口优化**：支持可配置的历史数据窗口大小
3. **业务标签**：结合业务标签进行分类检测

### 长期演进

1. **多维度融合**：结合延迟、错误率等其他指标
2. **机器学习**：引入简单的机器学习方法提升精度
3. **上下文感知**：考虑业务事件和系统变更的影响

## 📊 检测示例

### 正常场景
```
历史请求量: [100, 95, 105] → 平均值: 100
当前请求量: 120
增长倍数: 1.2 < 1.8 ✗
增长率: 20% < 100% ✗
结果: 正常波动
```

### 异常场景1：激增检测
```
历史请求量: [100, 95, 105] → 平均值: 100  
当前请求量: 180
增长倍数: 1.8 ≥ 1.8 ✓
结果: 中度激增异常
```

### 异常场景2：翻倍检测
```
历史请求量: [50, 55, 45] → 平均值: 50
当前请求量: 120
增长率: 140% ≥ 100% ✓
结果: 翻倍增长异常
```

## 📈 总结

Call Rate Anomaly的业务导向检测方法是一个**简单实用**的异常检测方案。它通过明确的业务规则（1.8倍激增、100%增长）来识别请求量的显著异常，具有**计算高效、易于理解、实时性好**的优点。

虽然在统计学严谨性和复杂场景适应性方面存在局限，但对于大多数**实时监控**和**初级异常检测**需求来说，这是一个非常合适的解决方案。

建议在使用时根据具体业务场景调整阈值参数，并结合其他监控手段形成完整的异常检测体系。 