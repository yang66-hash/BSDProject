# ä¸å‡è¡¡è´Ÿè½½æ£€æµ‹ç®—æ³•è¯´æ˜ä¸ä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

ä¸å‡è¡¡è´Ÿè½½æ£€æµ‹ç®—æ³•ç”¨äºè¯†åˆ«å¾®æœåŠ¡å®ä¾‹ä¸­å­˜åœ¨çš„èµ„æºåˆ©ç”¨ä¸å‡è¡¡é—®é¢˜ã€‚è¯¥ç®—æ³•ä¸»è¦æ£€æµ‹ä»¥ä¸‹å¼‚å¸¸æ¨¡å¼ï¼š

**æ£€æµ‹æ¡ä»¶ï¼šCPU/RAMä½¿ç”¨ç‡é«˜äºå®ä¾‹å¹³å‡å€¼(1+20%)ï¼Œä½†è¯·æ±‚æ•°é‡ä½äºå¹³å‡å€¼(1-20%)ï¼Œå»¶æ—¶é«˜äºå¹³å‡å€¼(1+20%)**

## ğŸ”§ ç®—æ³•é€»è¾‘

### 1. æ•°æ®æ”¶é›†

ç®—æ³•éœ€è¦ä»¥ä¸‹ä¸¤ç±»æŒ‡æ ‡æ•°æ®ï¼š

#### å†…éƒ¨æŒ‡æ ‡ (SvcMetricsRes)
- **CPUä½¿ç”¨ç‡**: `JVMSummaryRes.cpuProPCT` - è¿›ç¨‹CPUä½¿ç”¨ç™¾åˆ†æ¯”
- **å†…å­˜ä½¿ç”¨é‡**: `JVMSummaryRes.heapUsed` - JVMå †å†…å­˜ä½¿ç”¨é‡(å­—èŠ‚)

#### å¤–éƒ¨æŒ‡æ ‡ (SvcExternalMetricsRes)  
- **è¯·æ±‚æ•°é‡**: `requestCount` - æ—¶é—´é—´éš”å†…çš„è¯·æ±‚æ€»æ•°
- **å¹³å‡å»¶æ—¶**: `avgLatency` - æ‰€æœ‰è¯·æ±‚çš„å¹³å‡å“åº”æ—¶é—´(æ¯«ç§’)

### 2. å¹³å‡å€¼è®¡ç®—

ç®—æ³•è®¡ç®—æ‰€æœ‰å®ä¾‹çš„å¹³å‡æŒ‡æ ‡ï¼š

```java
// CPUå¹³å‡å€¼
avgCpuPct = allInstances.stream()
    .mapToDouble(JVMSummaryRes::getCpuProPCT)
    .average()

// å†…å­˜å¹³å‡å€¼  
avgMemoryUsed = allInstances.stream()
    .mapToLong(JVMSummaryRes::getHeapUsed)
    .average()

// è¯·æ±‚æ•°å¹³å‡å€¼
avgRequestCount = allInstances.stream()
    .mapToInt(SvcExternalMetricsRes::getRequestCount)
    .average()

// åŠ æƒå¹³å‡å»¶æ—¶
avgLatency = sum(latency * requestCount) / totalRequests
```

### 3. é˜ˆå€¼è®¡ç®—

åŸºäºå¹³å‡å€¼è®¡ç®—æ£€æµ‹é˜ˆå€¼ï¼ˆ20%å®¹å·®ï¼‰ï¼š

```java
double coefficient = 0.2;

// é«˜èµ„æºä½¿ç”¨é˜ˆå€¼
cpuThreshold = avgCpuPct * (1 + coefficient)      // +20%
memoryThreshold = avgMemoryUsed * (1 + coefficient) // +20%

// ä½è¯·æ±‚æ•°é˜ˆå€¼  
requestThreshold = avgRequestCount * (1 - coefficient) // -20%

// é«˜å»¶æ—¶é˜ˆå€¼
latencyThreshold = avgLatency * (1 + coefficient)     // +20%
```

### 4. å®ä¾‹æ£€æµ‹

å¯¹æ¯ä¸ªå®ä¾‹è¿›è¡Œå››ä¸ªæ¡ä»¶çš„æ£€æµ‹ï¼š

```java
boolean isUnevenLoad = 
    (currentCpuPct > cpuThreshold) &&           // CPUé«˜
    (currentMemoryUsed > memoryThreshold) &&   // å†…å­˜é«˜  
    (currentRequestCount < requestThreshold) && // è¯·æ±‚ä½
    (currentLatency > latencyThreshold);       // å»¶æ—¶é«˜
```

## ğŸ“Š æ£€æµ‹æ¡ä»¶è¯¦è§£

å½“ä¸€ä¸ªå®ä¾‹**åŒæ—¶æ»¡è¶³**ä»¥ä¸‹å››ä¸ªæ¡ä»¶æ—¶ï¼Œè¢«åˆ¤å®šä¸ºä¸å‡è¡¡è´Ÿè½½ï¼š

1. âœ… **CPUä½¿ç”¨ç‡é«˜äºå¹³å‡å€¼+20%**
2. âœ… **RAMä½¿ç”¨ç‡é«˜äºå¹³å‡å€¼+20%**  
3. âœ… **è¯·æ±‚æ•°é‡ä½äºå¹³å‡å€¼-20%**
4. âœ… **å»¶æ—¶é«˜äºå¹³å‡å€¼+20%**

## ğŸ’» ä»£ç å®ç°ç¤ºä¾‹

### 1. è°ƒç”¨æ£€æµ‹æœåŠ¡

```java
@RestController
@RequestMapping("/dynamic")
public class DynamicController {
    
    @Autowired
    private UnevenLoadDistributionService unevenLoadDistributionService;
    
    @PostMapping("/uneven-load-distribution")
    public ResponseDTO<String> detectUnevenLoadDistribution(@RequestBody RequestItem requestItem) {
        DetectionResItem result = unevenLoadDistributionService.unevenLoadDistributionDetect(requestItem);
        // å¤„ç†æ£€æµ‹ç»“æœ
        return ResponseDTO.success("æ£€æµ‹å®Œæˆ");
    }
}
```

### 2. æ£€æµ‹ç»“æœå¤„ç†

```java
// è·å–æ£€æµ‹ç»“æœ
UnevenLoadDistributionContext context = (UnevenLoadDistributionContext) result.getContext();

if (context.getStatus()) {
    System.out.println("å‘ç°ä¸å‡è¡¡è´Ÿè½½ï¼");
    
    // éå†æ¯ä¸ªå®ä¾‹çš„æ£€æµ‹ç»“æœ
    Map<String, UnevenLoadDisItem> instanceStatus = context.getInstanceStatus();
    for (Map.Entry<String, UnevenLoadDisItem> entry : instanceStatus.entrySet()) {
        String instanceName = entry.getKey();
        UnevenLoadDisItem item = entry.getValue();
        
        if (item.getStatus()) {
            System.out.printf("å®ä¾‹ %s å­˜åœ¨ä¸å‡è¡¡è´Ÿè½½:\n", instanceName);
            System.out.printf("  CPUä½¿ç”¨ç‡: %.2f%%\n", item.getPct());
            System.out.printf("  å†…å­˜ä½¿ç”¨: %.0f MB\n", item.getMemoryUsed() / (1024.0 * 1024.0));
            System.out.printf("  å¹³å‡å»¶æ—¶: %.2f ms\n", item.getAvgLatency());
        }
    }
} else {
    System.out.println("æ‰€æœ‰å®ä¾‹è´Ÿè½½å‡è¡¡æ­£å¸¸");
}
```

## ğŸ¯ å®é™…æ£€æµ‹åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸è´Ÿè½½åˆ†å¸ƒ

```
æœåŠ¡: user-service (2ä¸ªå®ä¾‹)

çª—å£å¹³å‡æŒ‡æ ‡:
- CPUå¹³å‡å€¼: 55.0%
- å†…å­˜å¹³å‡å€¼: 556 MB  
- è¯·æ±‚æ•°å¹³å‡å€¼: 1100
- å»¶æ—¶å¹³å‡å€¼: 110.0 ms

æ£€æµ‹é˜ˆå€¼:
- CPUé˜ˆå€¼: 66.0% (55% * 1.2)
- å†…å­˜é˜ˆå€¼: 667 MB (556MB * 1.2)
- è¯·æ±‚æ•°é˜ˆå€¼: 880 (1100 * 0.8)  
- å»¶æ—¶é˜ˆå€¼: 132.0 ms (110ms * 1.2)

å®ä¾‹æ£€æµ‹ç»“æœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®ä¾‹        â”‚ CPU     â”‚ å†…å­˜     â”‚ è¯·æ±‚æ•°  â”‚ å»¶æ—¶     â”‚ ç»“æœ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ instance-1  â”‚ 52%(âœ…) â”‚ 500MB(âœ…)â”‚ 1050(âœ…)â”‚ 105ms(âœ…)â”‚ âœ…æ­£å¸¸ â”‚
â”‚ instance-2  â”‚ 58%(âœ…) â”‚ 612MB(âœ…)â”‚ 1150(âœ…)â”‚ 115ms(âœ…)â”‚ âœ…æ­£å¸¸ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯2ï¼šæ£€æµ‹åˆ°ä¸å‡è¡¡è´Ÿè½½

```
æœåŠ¡: order-service (3ä¸ªå®ä¾‹)

çª—å£å¹³å‡æŒ‡æ ‡:
- CPUå¹³å‡å€¼: 45.0%
- å†…å­˜å¹³å‡å€¼: 400 MB
- è¯·æ±‚æ•°å¹³å‡å€¼: 800  
- å»¶æ—¶å¹³å‡å€¼: 90.0 ms

æ£€æµ‹é˜ˆå€¼:
- CPUé˜ˆå€¼: 54.0% (45% * 1.2)
- å†…å­˜é˜ˆå€¼: 480 MB (400MB * 1.2)
- è¯·æ±‚æ•°é˜ˆå€¼: 640 (800 * 0.8)
- å»¶æ—¶é˜ˆå€¼: 108.0 ms (90ms * 1.2)

å®ä¾‹æ£€æµ‹ç»“æœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®ä¾‹        â”‚ CPU     â”‚ å†…å­˜     â”‚ è¯·æ±‚æ•°  â”‚ å»¶æ—¶     â”‚ ç»“æœ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ instance-1  â”‚ 40%(âœ…) â”‚ 350MB(âœ…)â”‚ 850(âœ…) â”‚ 85ms(âœ…) â”‚ âœ…æ­£å¸¸         â”‚
â”‚ instance-2  â”‚ 42%(âœ…) â”‚ 380MB(âœ…)â”‚ 820(âœ…) â”‚ 88ms(âœ…) â”‚ âœ…æ­£å¸¸         â”‚
â”‚ instance-3  â”‚ 75%(âš ï¸) â”‚ 600MB(âš ï¸)â”‚ 500(âš ï¸) â”‚ 130ms(âš ï¸)â”‚ ğŸš¨ä¸å‡è¡¡è´Ÿè½½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ è­¦å‘Š: instance-3 å­˜åœ¨ä¸å‡è¡¡è´Ÿè½½
- CPUé«˜äºé˜ˆå€¼: 75% > 54%
- å†…å­˜é«˜äºé˜ˆå€¼: 600MB > 480MB  
- è¯·æ±‚æ•°ä½äºé˜ˆå€¼: 500 < 640
- å»¶æ—¶é«˜äºé˜ˆå€¼: 130ms > 108ms
```

## ğŸ” ç®—æ³•ç‰¹ç‚¹

### ä¼˜åŠ¿
1. **ç›¸å¯¹æ¯”è¾ƒ**: åŸºäºåŒæœåŠ¡å®ä¾‹é—´çš„ç›¸å¯¹æ¯”è¾ƒï¼Œé¿å…ç»å¯¹é˜ˆå€¼çš„å±€é™æ€§
2. **å¤šç»´åº¦æ£€æµ‹**: ç»¼åˆCPUã€å†…å­˜ã€è¯·æ±‚é‡ã€å»¶æ—¶å››ä¸ªç»´åº¦
3. **é€‚åº”æ€§å¼º**: è‡ªåŠ¨é€‚åº”ä¸åŒæœåŠ¡çš„è´Ÿè½½ç‰¹å¾
4. **è¯¯æŠ¥ç‡ä½**: éœ€è¦åŒæ—¶æ»¡è¶³å››ä¸ªæ¡ä»¶ï¼Œå‡å°‘è¯¯åˆ¤

### é€‚ç”¨åœºæ™¯
- **è´Ÿè½½å‡è¡¡å¼‚å¸¸**: æŸäº›å®ä¾‹è·å¾—è¿‡å°‘è¯·æ±‚ä½†èµ„æºæ¶ˆè€—è¿‡é«˜
- **æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**: è¯†åˆ«å¤„ç†æ•ˆç‡ä½ä¸‹çš„å®ä¾‹
- **èµ„æºæµªè´¹æ£€æµ‹**: å‘ç°èµ„æºåˆ©ç”¨ç‡ä¸å·¥ä½œè´Ÿè½½ä¸åŒ¹é…çš„æƒ…å†µ

## âš™ï¸ é…ç½®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| coefficient | 0.2 | å®¹å·®ç³»æ•°(20%) |
| æœ€å°å®ä¾‹æ•° | 2 | è‡³å°‘éœ€è¦2ä¸ªå®ä¾‹æ‰è¿›è¡Œæ£€æµ‹ |

## ğŸ“¤ è¾“å‡ºç»“æœ

### UnevenLoadDisItem å­—æ®µ
- `status`: æ˜¯å¦å­˜åœ¨ä¸å‡è¡¡è´Ÿè½½
- `pct`: å½“å‰CPUä½¿ç”¨ç‡
- `memoryUsed`: å½“å‰å†…å­˜ä½¿ç”¨é‡  
- `avgLatency`: å½“å‰å¹³å‡å»¶æ—¶