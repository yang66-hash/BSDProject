# ä¸å‡è¡¡è´Ÿè½½æ£€æµ‹ä½¿ç”¨ç¤ºä¾‹

## åŠŸèƒ½ç®€ä»‹

ä¸å‡è¡¡è´Ÿè½½æ£€æµ‹ç”¨äºè¯†åˆ«å¾®æœåŠ¡å®ä¾‹ä¸­èµ„æºä½¿ç”¨ä¸è¯·æ±‚å¤„ç†ä¸åŒ¹é…çš„é—®é¢˜ã€‚

### æ£€æµ‹æ¡ä»¶
å½“ä¸€ä¸ªå®ä¾‹**åŒæ—¶æ»¡è¶³**ä»¥ä¸‹å››ä¸ªæ¡ä»¶æ—¶ï¼Œè¢«åˆ¤å®šä¸ºä¸å‡è¡¡è´Ÿè½½ï¼š

1. âœ… **CPUä½¿ç”¨ç‡é«˜äºå¹³å‡å€¼+20%**
2. âœ… **RAMä½¿ç”¨ç‡é«˜äºå¹³å‡å€¼+20%**  
3. âœ… **è¯·æ±‚æ•°é‡ä½äºå¹³å‡å€¼-20%**
4. âœ… **å»¶æ—¶é«˜äºå¹³å‡å€¼+20%**

## ä»£ç å®ç°ç¤ºä¾‹

### 1. è°ƒç”¨æ£€æµ‹æœåŠ¡

```java
@RestController
@RequestMapping("/dynamic")
public class DynamicController {
    
    @Autowired
    private UnevenLoadDistributionService unevenLoadDistributionService;
    
    @PostMapping("/uneven-load-distribution")
    public ResponseDTO<String> detectUnevenLoadDistribution(@RequestBody RequestItem requestItem) {
        DetectionResItem result = unevenLoadDistributionService.unevenLoadDistributionDetect(requestItem);
        // å¤„ç†æ£€æµ‹ç»“æœ
        return ResponseDTO.success("æ£€æµ‹å®Œæˆ");
    }
}
```

### 2. æ£€æµ‹ç»“æœå¤„ç†

```java
// è·å–æ£€æµ‹ç»“æœ
UnevenLoadDistributionContext context = (UnevenLoadDistributionContext) result.getContext();

if (context.getStatus()) {
    System.out.println("å‘ç°ä¸å‡è¡¡è´Ÿè½½ï¼");
    
    // éå†æ¯ä¸ªå®ä¾‹çš„æ£€æµ‹ç»“æœ
    Map<String, UnevenLoadDisItem> instanceStatus = context.getInstanceStatus();
    for (Map.Entry<String, UnevenLoadDisItem> entry : instanceStatus.entrySet()) {
        String instanceName = entry.getKey();
        UnevenLoadDisItem item = entry.getValue();
        
        if (item.getStatus()) {
            System.out.printf("å®ä¾‹ %s å­˜åœ¨ä¸å‡è¡¡è´Ÿè½½:\n", instanceName);
            System.out.printf("  CPUä½¿ç”¨ç‡: %.2f%%\n", item.getPct());
            System.out.printf("  å†…å­˜ä½¿ç”¨: %.0f MB\n", item.getMemoryUsed() / (1024.0 * 1024.0));
            System.out.printf("  å¹³å‡å»¶æ—¶: %.2f ms\n", item.getAvgLatency());
        }
    }
} else {
    System.out.println("æ‰€æœ‰å®ä¾‹è´Ÿè½½å‡è¡¡æ­£å¸¸");
}
```

## å®é™…æ£€æµ‹åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸è´Ÿè½½åˆ†å¸ƒ

```
æœåŠ¡: user-service (2ä¸ªå®ä¾‹)

çª—å£å¹³å‡æŒ‡æ ‡:
- CPUå¹³å‡å€¼: 55.0%
- å†…å­˜å¹³å‡å€¼: 556 MB  
- è¯·æ±‚æ•°å¹³å‡å€¼: 1100
- å»¶æ—¶å¹³å‡å€¼: 110.0 ms

æ£€æµ‹é˜ˆå€¼:
- CPUé˜ˆå€¼: 66.0% (55% * 1.2)
- å†…å­˜é˜ˆå€¼: 667 MB (556MB * 1.2)
- è¯·æ±‚æ•°é˜ˆå€¼: 880 (1100 * 0.8)  
- å»¶æ—¶é˜ˆå€¼: 132.0 ms (110ms * 1.2)

å®ä¾‹æ£€æµ‹ç»“æœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®ä¾‹        â”‚ CPU     â”‚ å†…å­˜     â”‚ è¯·æ±‚æ•°  â”‚ å»¶æ—¶     â”‚ ç»“æœ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ instance-1  â”‚ 52%(âœ…) â”‚ 500MB(âœ…)â”‚ 1050(âœ…)â”‚ 105ms(âœ…)â”‚ âœ…æ­£å¸¸ â”‚
â”‚ instance-2  â”‚ 58%(âœ…) â”‚ 612MB(âœ…)â”‚ 1150(âœ…)â”‚ 115ms(âœ…)â”‚ âœ…æ­£å¸¸ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœºæ™¯2ï¼šæ£€æµ‹åˆ°ä¸å‡è¡¡è´Ÿè½½

```
æœåŠ¡: order-service (3ä¸ªå®ä¾‹)

çª—å£å¹³å‡æŒ‡æ ‡:
- CPUå¹³å‡å€¼: 45.0%
- å†…å­˜å¹³å‡å€¼: 400 MB
- è¯·æ±‚æ•°å¹³å‡å€¼: 800  
- å»¶æ—¶å¹³å‡å€¼: 90.0 ms

æ£€æµ‹é˜ˆå€¼:
- CPUé˜ˆå€¼: 54.0% (45% * 1.2)
- å†…å­˜é˜ˆå€¼: 480 MB (400MB * 1.2)
- è¯·æ±‚æ•°é˜ˆå€¼: 640 (800 * 0.8)
- å»¶æ—¶é˜ˆå€¼: 108.0 ms (90ms * 1.2)

å®ä¾‹æ£€æµ‹ç»“æœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®ä¾‹        â”‚ CPU     â”‚ å†…å­˜     â”‚ è¯·æ±‚æ•°  â”‚ å»¶æ—¶     â”‚ ç»“æœ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ instance-1  â”‚ 40%(âœ…) â”‚ 350MB(âœ…)â”‚ 850(âœ…) â”‚ 85ms(âœ…) â”‚ âœ…æ­£å¸¸         â”‚
â”‚ instance-2  â”‚ 42%(âœ…) â”‚ 380MB(âœ…)â”‚ 820(âœ…) â”‚ 88ms(âœ…) â”‚ âœ…æ­£å¸¸         â”‚
â”‚ instance-3  â”‚ 75%(âš ï¸) â”‚ 600MB(âš ï¸)â”‚ 500(âš ï¸) â”‚ 130ms(âš ï¸)â”‚ ğŸš¨ä¸å‡è¡¡è´Ÿè½½   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ è­¦å‘Š: instance-3 å­˜åœ¨ä¸å‡è¡¡è´Ÿè½½
- CPUé«˜äºé˜ˆå€¼: 75% > 54%
- å†…å­˜é«˜äºé˜ˆå€¼: 600MB > 480MB  
- è¯·æ±‚æ•°ä½äºé˜ˆå€¼: 500 < 640
- å»¶æ—¶é«˜äºé˜ˆå€¼: 130ms > 108ms
```

## æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### INFOçº§åˆ«æ—¥å¿—
```
2024-01-15 10:30:00 INFO  UnevenLoadDistributionService - å®ä¾‹å¹³å‡æŒ‡æ ‡ - CPU: 55.00%, å†…å­˜: 583168000 bytes, è¯·æ±‚æ•°: 1100, å»¶æ—¶: 110.00ms
2024-01-15 10:30:00 INFO  UnevenLoadDistributionService - æ£€æµ‹é˜ˆå€¼ - CPU: 66.00%, å†…å­˜: 699801600 bytes, è¯·æ±‚æ•°: 880, å»¶æ—¶: 132.00ms  
2024-01-15 10:30:01 INFO  UnevenLoadDistributionService - ä¸å‡è¡¡è´Ÿè½½æ£€æµ‹å®Œæˆï¼Œå‘ç° 1 ä¸ªå¼‚å¸¸å®ä¾‹
```

### WARNçº§åˆ«æ—¥å¿—ï¼ˆå‘ç°é—®é¢˜æ—¶ï¼‰
```
2024-01-15 10:30:01 WARN  UnevenLoadDistributionService - æ£€æµ‹åˆ°ä¸å‡è¡¡è´Ÿè½½å®ä¾‹: instance-3 - CPU: 75.00% > 66.00%, å†…å­˜: 600MB > 480MB, è¯·æ±‚æ•°: 500 < 880, å»¶æ—¶: 130.00ms > 132.00ms
```

### DEBUGçº§åˆ«æ—¥å¿—ï¼ˆæ­£å¸¸å®ä¾‹ï¼‰
```
2024-01-15 10:30:01 DEBUG UnevenLoadDistributionService - å®ä¾‹ instance-1 æ­£å¸¸ - CPU: 52.00%(æ­£å¸¸/66.00), å†…å­˜: 500MB(æ­£å¸¸/667MB), è¯·æ±‚æ•°: 1050(æ­£å¸¸/880), å»¶æ—¶: 105.00ms(æ­£å¸¸/132.00)
```

## é—®é¢˜æ’æŸ¥å»ºè®®

å½“æ£€æµ‹åˆ°ä¸å‡è¡¡è´Ÿè½½æ—¶ï¼Œå¯èƒ½çš„åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š

### 1. è´Ÿè½½å‡è¡¡å™¨é…ç½®é—®é¢˜
**ç°è±¡**: æŸäº›å®ä¾‹è¯·æ±‚æ•°æ˜æ˜¾åä½
**è§£å†³**: æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨çš„è·¯ç”±ç­–ç•¥å’Œå¥åº·æ£€æŸ¥é…ç½®

### 2. å®ä¾‹æ€§èƒ½ç“¶é¢ˆ  
**ç°è±¡**: CPU/å†…å­˜é«˜ï¼Œä½†å¤„ç†è¯·æ±‚å°‘ï¼Œå»¶æ—¶é«˜
**è§£å†³**: æ£€æŸ¥ä»£ç æ€§èƒ½é—®é¢˜ã€æ•°æ®åº“è¿æ¥ã€å¤–éƒ¨æœåŠ¡è°ƒç”¨ç­‰

### 3. èµ„æºåˆ†é…ä¸å½“
**ç°è±¡**: å†…å­˜é…ç½®è¿‡å°å¯¼è‡´é¢‘ç¹GC
**è§£å†³**: è°ƒæ•´JVMå†…å­˜é…ç½®å‚æ•°

### 4. ç½‘ç»œé—®é¢˜
**ç°è±¡**: æŸä¸ªå®ä¾‹ç½‘ç»œå»¶æ—¶è¾ƒé«˜
**è§£å†³**: æ£€æŸ¥ç½‘ç»œé…ç½®å’ŒæœåŠ¡é—´é€šä¿¡

## é…ç½®å»ºè®®

### æ£€æµ‹é¢‘ç‡
```yaml
# å»ºè®®æ¯5-10åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
uneven-load-detection:
  interval: 300  # ç§’
  enabled: true
```

### é˜ˆå€¼è°ƒæ•´
```java
// å¯æ ¹æ®ä¸šåŠ¡ç‰¹æ€§è°ƒæ•´å®¹å·®ç³»æ•°
private final double COEFFICIENT = 0.2;  // 20%å®¹å·®

// CPUå¯†é›†å‹æœåŠ¡å¯ä»¥æé«˜CPUé˜ˆå€¼
private final double CPU_COEFFICIENT = 0.3;  // 30%å®¹å·®

// IOå¯†é›†å‹æœåŠ¡å¯ä»¥æé«˜å»¶æ—¶é˜ˆå€¼  
private final double LATENCY_COEFFICIENT = 0.5;  // 50%å®¹å·®
```

## å‘Šè­¦é›†æˆ

### å‘Šè­¦è§„åˆ™å»ºè®®
```yaml
alert_rules:
  - name: "ä¸å‡è¡¡è´Ÿè½½æ£€æµ‹"
    condition: "uneven_load_instances > 0"
    duration: "10m"  # è¿ç»­10åˆ†é’Ÿå¼‚å¸¸æ‰å‘Šè­¦
    severity: "warning"
    message: "å‘ç° {{ uneven_load_instances }} ä¸ªä¸å‡è¡¡è´Ÿè½½å®ä¾‹"
```

### é’‰é’‰/ä¼å¾®å‘Šè­¦
```java
if (context.getStatus()) {
    String message = String.format(
        "âš ï¸ ä¸å‡è¡¡è´Ÿè½½å‘Šè­¦\n" +
        "æœåŠ¡: %s\n" + 
        "å¼‚å¸¸å®ä¾‹æ•°: %d\n" +
        "æ£€æµ‹æ—¶é—´: %s",
        serviceName, 
        abnormalInstanceCount,
        LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
    );
    
    // å‘é€é’‰é’‰å‘Šè­¦
    dingTalkService.sendAlert(message);
}
``` 