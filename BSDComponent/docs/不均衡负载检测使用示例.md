# 不均衡负载检测使用示例

## 功能简介

不均衡负载检测用于识别微服务实例中资源使用与请求处理不匹配的问题。

### 检测条件
当一个实例**同时满足**以下四个条件时，被判定为不均衡负载：

1. ✅ **CPU使用率高于平均值+20%**
2. ✅ **RAM使用率高于平均值+20%**  
3. ✅ **请求数量低于平均值-20%**
4. ✅ **延时高于平均值+20%**

## 代码实现示例

### 1. 调用检测服务

```java
@RestController
@RequestMapping("/dynamic")
public class DynamicController {
    
    @Autowired
    private UnevenLoadDistributionService unevenLoadDistributionService;
    
    @PostMapping("/uneven-load-distribution")
    public ResponseDTO<String> detectUnevenLoadDistribution(@RequestBody RequestItem requestItem) {
        DetectionResItem result = unevenLoadDistributionService.unevenLoadDistributionDetect(requestItem);
        // 处理检测结果
        return ResponseDTO.success("检测完成");
    }
}
```

### 2. 检测结果处理

```java
// 获取检测结果
UnevenLoadDistributionContext context = (UnevenLoadDistributionContext) result.getContext();

if (context.getStatus()) {
    System.out.println("发现不均衡负载！");
    
    // 遍历每个实例的检测结果
    Map<String, UnevenLoadDisItem> instanceStatus = context.getInstanceStatus();
    for (Map.Entry<String, UnevenLoadDisItem> entry : instanceStatus.entrySet()) {
        String instanceName = entry.getKey();
        UnevenLoadDisItem item = entry.getValue();
        
        if (item.getStatus()) {
            System.out.printf("实例 %s 存在不均衡负载:\n", instanceName);
            System.out.printf("  CPU使用率: %.2f%%\n", item.getPct());
            System.out.printf("  内存使用: %.0f MB\n", item.getMemoryUsed() / (1024.0 * 1024.0));
            System.out.printf("  平均延时: %.2f ms\n", item.getAvgLatency());
        }
    }
} else {
    System.out.println("所有实例负载均衡正常");
}
```

## 实际检测场景

### 场景1：正常负载分布

```
服务: user-service (2个实例)

窗口平均指标:
- CPU平均值: 55.0%
- 内存平均值: 556 MB  
- 请求数平均值: 1100
- 延时平均值: 110.0 ms

检测阈值:
- CPU阈值: 66.0% (55% * 1.2)
- 内存阈值: 667 MB (556MB * 1.2)
- 请求数阈值: 880 (1100 * 0.8)  
- 延时阈值: 132.0 ms (110ms * 1.2)

实例检测结果:
┌─────────────┬─────────┬──────────┬─────────┬──────────┬────────┐
│ 实例        │ CPU     │ 内存     │ 请求数  │ 延时     │ 结果   │
├─────────────┼─────────┼──────────┼─────────┼──────────┼────────┤
│ instance-1  │ 52%(✅) │ 500MB(✅)│ 1050(✅)│ 105ms(✅)│ ✅正常 │
│ instance-2  │ 58%(✅) │ 612MB(✅)│ 1150(✅)│ 115ms(✅)│ ✅正常 │
└─────────────┴─────────┴──────────┴─────────┴──────────┴────────┘
```

### 场景2：检测到不均衡负载

```
服务: order-service (3个实例)

窗口平均指标:
- CPU平均值: 45.0%
- 内存平均值: 400 MB
- 请求数平均值: 800  
- 延时平均值: 90.0 ms

检测阈值:
- CPU阈值: 54.0% (45% * 1.2)
- 内存阈值: 480 MB (400MB * 1.2)
- 请求数阈值: 640 (800 * 0.8)
- 延时阈值: 108.0 ms (90ms * 1.2)

实例检测结果:
┌─────────────┬─────────┬──────────┬─────────┬──────────┬────────────────┐
│ 实例        │ CPU     │ 内存     │ 请求数  │ 延时     │ 结果           │
├─────────────┼─────────┼──────────┼─────────┼──────────┼────────────────┤
│ instance-1  │ 40%(✅) │ 350MB(✅)│ 850(✅) │ 85ms(✅) │ ✅正常         │
│ instance-2  │ 42%(✅) │ 380MB(✅)│ 820(✅) │ 88ms(✅) │ ✅正常         │
│ instance-3  │ 75%(⚠️) │ 600MB(⚠️)│ 500(⚠️) │ 130ms(⚠️)│ 🚨不均衡负载   │
└─────────────┴─────────┴──────────┴─────────┴──────────┴────────────────┘

⚠️ 警告: instance-3 存在不均衡负载
- CPU高于阈值: 75% > 54%
- 内存高于阈值: 600MB > 480MB  
- 请求数低于阈值: 500 < 640
- 延时高于阈值: 130ms > 108ms
```

## 日志输出示例

### INFO级别日志
```
2024-01-15 10:30:00 INFO  UnevenLoadDistributionService - 实例平均指标 - CPU: 55.00%, 内存: 583168000 bytes, 请求数: 1100, 延时: 110.00ms
2024-01-15 10:30:00 INFO  UnevenLoadDistributionService - 检测阈值 - CPU: 66.00%, 内存: 699801600 bytes, 请求数: 880, 延时: 132.00ms  
2024-01-15 10:30:01 INFO  UnevenLoadDistributionService - 不均衡负载检测完成，发现 1 个异常实例
```

### WARN级别日志（发现问题时）
```
2024-01-15 10:30:01 WARN  UnevenLoadDistributionService - 检测到不均衡负载实例: instance-3 - CPU: 75.00% > 66.00%, 内存: 600MB > 480MB, 请求数: 500 < 880, 延时: 130.00ms > 132.00ms
```

### DEBUG级别日志（正常实例）
```
2024-01-15 10:30:01 DEBUG UnevenLoadDistributionService - 实例 instance-1 正常 - CPU: 52.00%(正常/66.00), 内存: 500MB(正常/667MB), 请求数: 1050(正常/880), 延时: 105.00ms(正常/132.00)
```

## 问题排查建议

当检测到不均衡负载时，可能的原因和解决方案：

### 1. 负载均衡器配置问题
**现象**: 某些实例请求数明显偏低
**解决**: 检查负载均衡器的路由策略和健康检查配置

### 2. 实例性能瓶颈  
**现象**: CPU/内存高，但处理请求少，延时高
**解决**: 检查代码性能问题、数据库连接、外部服务调用等

### 3. 资源分配不当
**现象**: 内存配置过小导致频繁GC
**解决**: 调整JVM内存配置参数

### 4. 网络问题
**现象**: 某个实例网络延时较高
**解决**: 检查网络配置和服务间通信

## 配置建议

### 检测频率
```yaml
# 建议每5-10分钟检测一次
uneven-load-detection:
  interval: 300  # 秒
  enabled: true
```

### 阈值调整
```java
// 可根据业务特性调整容差系数
private final double COEFFICIENT = 0.2;  // 20%容差

// CPU密集型服务可以提高CPU阈值
private final double CPU_COEFFICIENT = 0.3;  // 30%容差

// IO密集型服务可以提高延时阈值  
private final double LATENCY_COEFFICIENT = 0.5;  // 50%容差
```

## 告警集成

### 告警规则建议
```yaml
alert_rules:
  - name: "不均衡负载检测"
    condition: "uneven_load_instances > 0"
    duration: "10m"  # 连续10分钟异常才告警
    severity: "warning"
    message: "发现 {{ uneven_load_instances }} 个不均衡负载实例"
```

### 钉钉/企微告警
```java
if (context.getStatus()) {
    String message = String.format(
        "⚠️ 不均衡负载告警\n" +
        "服务: %s\n" + 
        "异常实例数: %d\n" +
        "检测时间: %s",
        serviceName, 
        abnormalInstanceCount,
        LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
    );
    
    // 发送钉钉告警
    dingTalkService.sendAlert(message);
}
``` 